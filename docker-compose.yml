# ─────────────────────────────────────────────
# PyScreenSaverBot — docker-compose.yml
#
# Services
#   web           Django + Gunicorn (main web process)
#   http_fetcher  Polls configured HTTP image sources on their set interval
#   cleanup       Enforces media folder size limit, deletes oldest images
#
# All three services share the same image and the same volume mounts
# so they read/write the same SQLite DB, media files, and logs.
#
# Persistent data is stored in bind-mounted host directories:
#   ./data/   → SQLite database  (configure DATABASES NAME to data/db.sqlite3)
#   ./media/  → images + previews
#   ./logs/   → app.log
#
# Usage:
#   cp .env.example .env        # fill in secrets
#   docker compose up -d        # start all services
#   docker compose logs -f      # follow logs
# ─────────────────────────────────────────────

services:

  # ── Web: Django + Gunicorn ─────────────────
  web:
    build: .
    restart: unless-stopped
    ports:
      - "${HOST_PORT:-8000}:8000"
    env_file: .env
    volumes:
      - ./data:/app/data        # SQLite database
      - ./media:/app/media      # images + previews
      - ./logs:/app/logs        # app.log
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/previews')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ── HTTP Fetcher: polls all enabled HTTP sources ──
  # Runs run_http_fetcher every hour; is_due() inside the command
  # decides per-source whether to actually fetch based on fetch_interval.
  http_fetcher:
    build: .
    restart: unless-stopped
    command: >
      sh -c "
        while true; do
          echo \"[http_fetcher] $(date): running run_http_fetcher\";
          python manage.py run_http_fetcher;
          sleep 3600;
        done
      "
    env_file: .env
    volumes:
      - ./data:/app/data
      - ./media:/app/media
      - ./logs:/app/logs
    depends_on:
      - web

  # ── Cleanup: enforces media folder size limit ──
  # Runs run_cleanup every hour; internal logic only deletes when limit exceeded.
  cleanup:
    build: .
    restart: unless-stopped
    command: >
      sh -c "
        while true; do
          echo \"[cleanup] $(date): running run_cleanup\";
          python manage.py run_cleanup;
          sleep 3600;
        done
      "
    env_file: .env
    volumes:
      - ./data:/app/data
      - ./media:/app/media
      - ./logs:/app/logs
    depends_on:
      - web
