<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ScreenSaver</title>
  <style>
    /* ── Reset & base ─────────────────────────────────────────────── */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100vw;
      height: 100vh;
      background: #000;
      overflow: hidden;
      font-family: sans-serif;
    }

    /* ── Phase 1: Preview collage ─────────────────────────────────── */
    #collage {
      position: fixed;
      inset: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      padding: 3px;
      background: #111;
      align-content: flex-start;
      opacity: 1;
      transition: opacity 1.2s ease;
    }

    .thumb {
      flex: 1 1 18%;
      min-width: 120px;
      max-height: 34vh;
      overflow: hidden;
      background: #222;
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* ── Phase 2: Slideshow ───────────────────────────────────────── */
    #slideshow {
      position: fixed;
      inset: 0;
      background: #000;
      opacity: 0;
      pointer-events: none;
    }

    .slide {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }

    .slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      image-orientation: from-image;
    }

    /* ── Transition keyframes ─────────────────────────────────────── */
    @keyframes burnIn     { from { filter: brightness(0); }                       to { filter: brightness(1); } }
    @keyframes fadeIn     { from { opacity: 0; }                                  to { opacity: 1; } }
    @keyframes slideIn    { from { transform: translateX(100%); }                 to { transform: translateX(0); } }
    @keyframes zoomIn     { from { transform: scale(1.15); opacity: 0; }          to { transform: scale(1); opacity: 1; } }
    @keyframes blurIn     { from { filter: blur(24px); opacity: 0; }              to { filter: blur(0); opacity: 1; } }
    @keyframes flipIn     { from { transform: perspective(1200px) rotateY(-90deg); opacity: 0; }
                            to   { transform: perspective(1200px) rotateY(0deg);  opacity: 1; } }
    @keyframes wipeUpIn   { from { transform: translateY(100%); }                 to { transform: translateY(0); } }
    @keyframes wipeDownIn { from { transform: translateY(-100%); }                to { transform: translateY(0); } }
    @keyframes irisIn     { from { clip-path: circle(0% at 50% 50%); }            to { clip-path: circle(150% at 50% 50%); } }
    @keyframes newspaperIn {
      from { transform: rotate(-12deg) scale(0.1); opacity: 0; }
      to   { transform: rotate(0)      scale(1);   opacity: 1; }
    }
    @keyframes glitchIn {
      0%   { clip-path: inset(40% 0 40% 0); transform: translateX(-12px); opacity: 0;   }
      20%  { clip-path: inset(5%  0 65% 0); transform: translateX(10px);  opacity: 0.5; }
      40%  { clip-path: inset(60% 0 5%  0); transform: translateX(-6px);  opacity: 0.7; }
      60%  { clip-path: inset(0%  0 0%  0); transform: translateX(4px);   opacity: 0.85;}
      80%  { clip-path: inset(0%  0 0%  0); transform: translateX(-2px);  opacity: 0.95;}
      100% { clip-path: inset(0%  0 0%  0); transform: translateX(0);     opacity: 1;   }
    }
    @keyframes squeezeIn  { from { transform: scaleX(0); }                        to { transform: scaleX(1); } }

    .transition-burn      { animation: burnIn      1.4s ease         forwards; }
    .transition-fade      { animation: fadeIn      1.4s ease         forwards; }
    .transition-slide     { animation: slideIn     0.9s ease         forwards; }
    .transition-zoom      { animation: zoomIn      1.4s ease         forwards; }
    .transition-blur      { animation: blurIn      1.2s ease         forwards; }
    .transition-flip      { animation: flipIn      0.8s ease         forwards; }
    .transition-wipe-up   { animation: wipeUpIn    0.8s ease         forwards; }
    .transition-wipe-down { animation: wipeDownIn  0.8s ease         forwards; }
    .transition-iris      { animation: irisIn      1.0s ease         forwards; }
    .transition-newspaper { animation: newspaperIn 0.8s ease         forwards; }
    .transition-glitch    { animation: glitchIn    0.55s linear      forwards; }
    .transition-squeeze   { animation: squeezeIn   0.7s ease         forwards; }

    /* ── Empty-state message ──────────────────────────────────────── */
    #empty {
      display: none;
      position: fixed;
      inset: 0;
      align-items: center;
      justify-content: center;
      color: #555;
      font-size: 1.4rem;
      letter-spacing: 0.05em;
    }

    /* ── Debug hint ───────────────────────────────────────────────── */
    #dbg-hint {
      position: fixed;
      bottom: 10px;
      right: 14px;
      z-index: 500;
      color: rgba(255, 255, 255, 0.18);
      font-family: monospace;
      font-size: 0.72rem;
      letter-spacing: 0.04em;
      pointer-events: none;
      user-select: none;
    }

    /* ── Debug: nav buttons ───────────────────────────────────────── */
    .dbg-nav {
      display: none;
      position: fixed;
      top: 0;
      bottom: 0;
      width: 80px;
      z-index: 999;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.35);
      font-size: 4rem;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, color 0.2s;
    }
    .dbg-nav:hover { background: rgba(255, 255, 255, 0.10); color: #fff; }
    .dbg-nav.visible { display: flex; }
    #dbg-prev { left: 0; }
    #dbg-next { right: 0; }

    /* ── Debug: info bar ──────────────────────────────────────────── */
    #dbg-bar {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.85);
      color: #ccc;
      font-family: monospace;
      font-size: 0.82rem;
      padding: 8px 14px 9px;
      border-top: 1px solid rgba(255, 235, 59, 0.35);
      line-height: 1.8;
    }
    #dbg-bar.visible { display: block; }

    #dbg-bar .lbl  { color: #ffeb3b; font-weight: bold; }
    #dbg-bar .sep  { color: #444; margin: 0 6px; }
    #dbg-bar .ok   { color: #69f0ae; }
    #dbg-bar .err  { color: #ff5252; }
    #dbg-bar .dim  { color: #666; }
    #dbg-bar .url  { color: #80d8ff; font-size: 0.78rem; }

    #dbg-bar kbd {
      background: #2a2a2a;
      border: 1px solid #555;
      border-radius: 3px;
      padding: 0 5px;
      font-size: 0.75rem;
    }

    #dbg-bar select {
      background: #1e1e1e;
      color: #eee;
      border: 1px solid #555;
      border-radius: 3px;
      font-family: monospace;
      font-size: 0.8rem;
      padding: 1px 4px;
      cursor: pointer;
      outline: none;
    }
    #dbg-bar select:focus { border-color: #ffeb3b; }
  </style>
</head>
<body>

<div id="collage"></div>
<div id="slideshow"></div>
<div id="empty">No images yet — waiting for ingestion...</div>

<div id="dbg-hint">press D for debug</div>

<!-- Debug controls (hidden until D is pressed) -->
<button id="dbg-prev" class="dbg-nav" title="Previous (←)">&#8249;</button>
<button id="dbg-next" class="dbg-nav" title="Next (→)">&#8250;</button>

<div id="dbg-bar">
  <div>
    <span class="lbl">DEBUG</span>
    <span class="sep">|</span>
    <kbd>D</kbd> exit
    <span class="sep">|</span>
    <kbd>&#8592;</kbd><kbd>&#8594;</kbd> navigate
    <span class="sep">|</span>
    <span id="dbg-idx">— / —</span>
    <span class="sep">|</span>
    transition
    <select id="dbg-t-sel">
      <option value="random">random</option>
      <option value="burn">burn</option>
      <option value="fade">fade</option>
      <option value="slide">slide</option>
      <option value="zoom">zoom</option>
      <option value="blur">blur</option>
      <option value="flip">flip</option>
      <option value="wipe-up">wipe up</option>
      <option value="wipe-down">wipe down</option>
      <option value="iris">iris</option>
      <option value="newspaper">newspaper</option>
      <option value="glitch">glitch</option>
      <option value="squeeze">squeeze</option>
    </select>
    <span id="dbg-last-t" class="dim"></span>
    <span class="sep">|</span>
    interval
    <select id="dbg-i-sel">
      <option value="1000">1 s</option>
      <option value="2000">2 s</option>
      <option value="3000">3 s</option>
      <option value="5000">5 s</option>
      <option value="10000">10 s</option>
      <option value="30000">30 s</option>
      <option value="60000">60 s</option>
    </select>
    <span class="sep">|</span>
    <span id="dbg-status" class="dim">—</span>
  </div>
  <div class="url" id="dbg-url">—</div>
</div>

<script>
  "use strict";

  // ── Config injected by Django ──────────────────────────────────────────────
  const GRID_REFRESH_MS       = {{ grid_fetch_interval_seconds }} * 1000;
  const SERVER_INTERVAL_MS    = {{ slideshow_interval_seconds }} * 1000;
  const SERVER_TRANSITION     = "{{ transition }}";
  const SERVER_TRANSITION_MODE = "{{ transition_mode }}";

  const ALL_TRANSITIONS = [
    "burn", "fade", "slide", "zoom",
    "blur", "flip", "wipe-up", "wipe-down",
    "iris", "newspaper", "glitch", "squeeze",
  ];

  // ── State ──────────────────────────────────────────────────────────────────
  let previews      = [];
  let slideIndex    = 0;
  let inSlideshow   = false;
  let slideTimer    = null;

  // ── Debug state (persisted in localStorage) ────────────────────────────────
  let debugMode       = false;
  let activeTransition = "random";   // "random"|"burn"|"fade"|"slide"|"zoom"
  let activeIntervalMs = SERVER_INTERVAL_MS;

  let dbgLastTransition = "";
  let dbgLoadStatus     = "";        // "loading" | "ok" | "error"
  let dbgErrorDetail    = "";

  // ── localStorage keys ──────────────────────────────────────────────────────
  const LS_DEBUG      = "ss_debug";
  const LS_TRANSITION = "ss_transition";
  const LS_INTERVAL   = "ss_interval_ms";

  // ── Helpers ────────────────────────────────────────────────────────────────
  function pickTransition() {
    if (activeTransition && activeTransition !== "random") {
      return activeTransition;
    }
    // "random" override, or server default
    if (SERVER_TRANSITION_MODE === "random" || activeTransition === "random") {
      return ALL_TRANSITIONS[Math.floor(Math.random() * ALL_TRANSITIONS.length)];
    }
    return SERVER_TRANSITION;
  }

  function imageUrl(filename) {
    return "/media/images/" + filename;
  }

  function restartTimer() {
    if (slideTimer) { clearInterval(slideTimer); slideTimer = null; }
    if (inSlideshow && !debugMode) {
      slideTimer = setInterval(advance, activeIntervalMs);
    }
  }

  // ── Debug overlay ──────────────────────────────────────────────────────────
  function setDebugMode(on) {
    debugMode = on;
    localStorage.setItem(LS_DEBUG, on ? "true" : "false");

    document.getElementById("dbg-bar").classList.toggle("visible", on);
    document.getElementById("dbg-prev").classList.toggle("visible", on);
    document.getElementById("dbg-next").classList.toggle("visible", on);
    document.getElementById("dbg-hint").style.display = on ? "none" : "";
    document.getElementById("slideshow").style.pointerEvents = on ? "auto" : "none";

    restartTimer();
    updateDebugBar();
  }

  function updateDebugBar() {
    if (!debugMode) return;
    const p = previews[slideIndex];

    document.getElementById("dbg-idx").textContent =
      p ? (slideIndex + 1) + " / " + previews.length : "— / —";
    document.getElementById("dbg-url").textContent =
      p ? imageUrl(p.filename) : "—";
    document.getElementById("dbg-last-t").textContent =
      dbgLastTransition ? "(" + dbgLastTransition + ")" : "";

    const statusEl = document.getElementById("dbg-status");
    if (dbgLoadStatus === "ok") {
      statusEl.className = "ok";
      statusEl.textContent = "\u2713 loaded";
    } else if (dbgLoadStatus === "error") {
      statusEl.className = "err";
      statusEl.textContent = "\u2717 failed" + (dbgErrorDetail ? " \u2014 " + dbgErrorDetail : "");
    } else {
      statusEl.className = "dim";
      statusEl.textContent = dbgLoadStatus === "loading" ? "loading\u2026" : "\u2014";
    }
  }

  // ── Debug select: transition ───────────────────────────────────────────────
  document.getElementById("dbg-t-sel").addEventListener("change", function() {
    activeTransition = this.value;
    localStorage.setItem(LS_TRANSITION, activeTransition);
  });

  // ── Debug select: interval ─────────────────────────────────────────────────
  document.getElementById("dbg-i-sel").addEventListener("change", function() {
    activeIntervalMs = parseInt(this.value);
    localStorage.setItem(LS_INTERVAL, activeIntervalMs);
    restartTimer();
  });

  // ── Keyboard + button navigation ───────────────────────────────────────────
  document.addEventListener("keydown", function(e) {
    // Don't intercept when typing in a select
    if (e.target.tagName === "SELECT") return;

    if (e.key === "d" || e.key === "D") {
      setDebugMode(!debugMode);
      return;
    }
    if (!debugMode) return;
    if (e.key === "ArrowLeft") {
      slideIndex = (slideIndex - 1 + Math.max(previews.length, 1)) % Math.max(previews.length, 1);
      showSlide(slideIndex);
    } else if (e.key === "ArrowRight") {
      slideIndex = (slideIndex + 1) % Math.max(previews.length, 1);
      showSlide(slideIndex);
    }
  });

  document.getElementById("dbg-prev").addEventListener("click", function() {
    slideIndex = (slideIndex - 1 + Math.max(previews.length, 1)) % Math.max(previews.length, 1);
    showSlide(slideIndex);
  });

  document.getElementById("dbg-next").addEventListener("click", function() {
    slideIndex = (slideIndex + 1) % Math.max(previews.length, 1);
    showSlide(slideIndex);
  });

  // ── Phase 1: collage ───────────────────────────────────────────────────────
  async function fetchPreviews() {
    try {
      const resp = await fetch("/api/previews");
      if (!resp.ok) return;
      const fresh = await resp.json();

      if (fresh.length === 0) {
        document.getElementById("empty").style.display = "flex";
        return;
      }
      document.getElementById("empty").style.display = "none";

      const oldCount = previews.length;
      previews = fresh;

      if (!inSlideshow) {
        renderCollage();
        if (previews.length > 0) {
          setTimeout(enterSlideshow, 3000);
        }
      } else if (previews.length > oldCount) {
        // New images arrived while slideshowing — queue is already updated
      }
    } catch (err) {
      console.warn("fetchPreviews error:", err);
    }
  }

  function renderCollage() {
    const collage = document.getElementById("collage");
    collage.innerHTML = "";
    previews.forEach(function(p) {
      const wrap = document.createElement("div");
      wrap.className = "thumb";
      const img = document.createElement("img");
      img.src = p.preview_url;
      img.alt = p.filename;
      img.loading = "lazy";
      wrap.appendChild(img);
      collage.appendChild(wrap);
    });
  }

  // ── Phase 2: slideshow ─────────────────────────────────────────────────────
  function enterSlideshow() {
    if (inSlideshow) return;
    inSlideshow = true;

    const collage   = document.getElementById("collage");
    const slideshow = document.getElementById("slideshow");

    collage.style.opacity = "0";
    setTimeout(function() {
      collage.style.display = "none";
      slideshow.style.opacity = "1";
      showSlide(slideIndex);
      restartTimer();
    }, 1200);
  }

  function advance() {
    slideIndex = (slideIndex + 1) % Math.max(previews.length, 1);
    showSlide(slideIndex);
  }

  function showSlide(index) {
    const preview = previews[index];
    if (!preview) return;

    const slideshow  = document.getElementById("slideshow");
    const transition = pickTransition();

    dbgLastTransition = transition;
    dbgLoadStatus     = "loading";
    dbgErrorDetail    = "";
    updateDebugBar();

    const img = new Image();
    img.src = imageUrl(preview.filename);

    img.onload = function() {
      dbgLoadStatus = "ok";
      updateDebugBar();

      const slide = document.createElement("div");
      slide.className = "slide transition-" + transition;
      const imgEl = document.createElement("img");
      imgEl.src = imageUrl(preview.filename);
      imgEl.alt = preview.filename;
      slide.appendChild(imgEl);
      slideshow.appendChild(slide);

      const slides = slideshow.querySelectorAll(".slide");
      if (slides.length > 2) { slides[0].remove(); }
    };

    img.onerror = function() {
      dbgLoadStatus  = "error";
      dbgErrorDetail = "browser could not load image";
      updateDebugBar();
      console.error("Failed to load image:", imageUrl(preview.filename));
    };
  }

  // ── Boot: restore persisted debug settings ─────────────────────────────────
  (function restoreDebugSettings() {
    // Transition
    const storedT = localStorage.getItem(LS_TRANSITION);
    if (storedT) activeTransition = storedT;
    document.getElementById("dbg-t-sel").value = activeTransition;

    // Interval — ensure the stored/server value appears in the select
    const storedI = localStorage.getItem(LS_INTERVAL);
    if (storedI) activeIntervalMs = parseInt(storedI);
    const iSel = document.getElementById("dbg-i-sel");
    if (![...iSel.options].some(function(o) { return parseInt(o.value) === activeIntervalMs; })) {
      const opt = document.createElement("option");
      opt.value = activeIntervalMs;
      opt.textContent = (activeIntervalMs / 1000) + " s";
      iSel.insertBefore(opt, iSel.firstChild);
    }
    iSel.value = activeIntervalMs;

    // Debug mode
    if (localStorage.getItem(LS_DEBUG) === "true") {
      setDebugMode(true);
    }
  })();

  // ── Boot ───────────────────────────────────────────────────────────────────
  fetchPreviews();
  setInterval(fetchPreviews, GRID_REFRESH_MS);
</script>

</body>
</html>
