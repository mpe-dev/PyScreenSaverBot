<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ScreenSaver</title>
  <style>
    /* ── Reset & base ─────────────────────────────────────────────── */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100vw;
      height: 100vh;
      background: #000;
      overflow: hidden;
      font-family: sans-serif;
    }

    /* ── Phase 1: Preview collage ─────────────────────────────────── */
    #collage {
      position: fixed;
      inset: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      padding: 3px;
      background: #111;
      align-content: flex-start;
      opacity: 1;
      transition: opacity 1.2s ease;
    }

    .thumb {
      flex: 1 1 18%;
      min-width: 120px;
      max-height: 34vh;
      overflow: hidden;
      background: #222;
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* ── Phase 2: Slideshow ───────────────────────────────────────── */
    #slideshow {
      position: fixed;
      inset: 0;
      background: #000;
      opacity: 0;
      pointer-events: none;
    }

    .slide {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }

    .slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      image-orientation: from-image;
    }

    /* ── Transition keyframes ─────────────────────────────────────── */
    @keyframes burnIn   { from { filter: brightness(0); } to { filter: brightness(1); } }
    @keyframes fadeIn   { from { opacity: 0; }            to { opacity: 1; } }
    @keyframes slideIn  { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes zoomIn   { from { transform: scale(1.15); opacity: 0; }
                          to   { transform: scale(1);    opacity: 1; } }

    .transition-burn  { animation: burnIn  1.4s ease forwards; }
    .transition-fade  { animation: fadeIn  1.4s ease forwards; }
    .transition-slide { animation: slideIn 0.9s ease forwards; }
    .transition-zoom  { animation: zoomIn  1.4s ease forwards; }

    /* ── Empty-state message ──────────────────────────────────────── */
    #empty {
      display: none;
      position: fixed;
      inset: 0;
      align-items: center;
      justify-content: center;
      color: #555;
      font-size: 1.4rem;
      letter-spacing: 0.05em;
    }

    /* ── Debug: nav buttons ───────────────────────────────────────── */
    .dbg-nav {
      display: none;
      position: fixed;
      top: 0;
      bottom: 0;
      width: 80px;
      z-index: 999;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.35);
      font-size: 4rem;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, color 0.2s;
    }
    .dbg-nav:hover { background: rgba(255, 255, 255, 0.10); color: #fff; }
    .dbg-nav.visible { display: flex; }
    #dbg-prev { left: 0; }
    #dbg-next { right: 0; }

    /* ── Debug: info bar ──────────────────────────────────────────── */
    #dbg-bar {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.82);
      color: #ccc;
      font-family: monospace;
      font-size: 0.82rem;
      padding: 9px 16px;
      border-top: 1px solid rgba(255, 235, 59, 0.35);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.7;
    }
    #dbg-bar.visible { display: block; }
    #dbg-bar .lbl  { color: #ffeb3b; font-weight: bold; }
    #dbg-bar .url  { color: #80d8ff; }
    #dbg-bar .ok   { color: #69f0ae; }
    #dbg-bar .err  { color: #ff5252; }
    #dbg-bar .dim  { color: #666; }
    #dbg-bar kbd   { background: #333; border: 1px solid #555; border-radius: 3px;
                     padding: 0 5px; font-size: 0.78rem; }
  </style>
</head>
<body>

<div id="collage"></div>
<div id="slideshow"></div>
<div id="empty">No images yet — waiting for ingestion...</div>

<!-- Debug controls (hidden until D is pressed) -->
<button id="dbg-prev" class="dbg-nav" title="Previous (←)">&#8249;</button>
<button id="dbg-next" class="dbg-nav" title="Next (→)">&#8250;</button>
<div id="dbg-bar"></div>

<script>
  "use strict";

  // ── Config injected by Django ──────────────────────────────────────────────
  const GRID_REFRESH_MS   = {{ grid_fetch_interval_seconds }} * 1000;
  const SLIDE_INTERVAL_MS = {{ slideshow_interval_seconds }} * 1000;
  const TRANSITION        = "{{ transition }}";
  const TRANSITION_MODE   = "{{ transition_mode }}";

  const ALL_TRANSITIONS = ["burn", "fade", "slide", "zoom"];

  // ── State ──────────────────────────────────────────────────────────────────
  let previews      = [];
  let slideIndex    = 0;
  let inSlideshow   = false;
  let slideTimer    = null;

  // ── Debug state ────────────────────────────────────────────────────────────
  let debugMode      = false;
  let dbgTransition  = "";
  let dbgLoadStatus  = "";   // "loading" | "ok" | "error"
  let dbgErrorDetail = "";

  // ── Helpers ────────────────────────────────────────────────────────────────
  function pickTransition() {
    if (TRANSITION_MODE === "random") {
      return ALL_TRANSITIONS[Math.floor(Math.random() * ALL_TRANSITIONS.length)];
    }
    return TRANSITION;
  }

  function imageUrl(filename) {
    return "/media/images/" + filename;
  }

  // ── Debug overlay ──────────────────────────────────────────────────────────
  function setDebugMode(on) {
    debugMode = on;
    document.getElementById("dbg-bar").classList.toggle("visible", on);
    document.getElementById("dbg-prev").classList.toggle("visible", on);
    document.getElementById("dbg-next").classList.toggle("visible", on);
    document.getElementById("slideshow").style.pointerEvents = on ? "auto" : "none";

    if (on && slideTimer) {
      clearInterval(slideTimer);
      slideTimer = null;
    } else if (!on && inSlideshow && !slideTimer) {
      slideTimer = setInterval(advance, SLIDE_INTERVAL_MS);
    }
    updateDebugBar();
  }

  function updateDebugBar() {
    if (!debugMode) return;
    const bar = document.getElementById("dbg-bar");
    const p   = previews[slideIndex];

    if (!p) {
      bar.innerHTML = '<span class="lbl">DEBUG</span> &nbsp;—&nbsp; no images loaded';
      return;
    }

    const url = imageUrl(p.filename);
    let statusHtml;
    if (dbgLoadStatus === "ok") {
      statusHtml = '<span class="ok">&#10003; loaded</span>';
    } else if (dbgLoadStatus === "error") {
      statusHtml = '<span class="err">&#10007; load failed' +
        (dbgErrorDetail ? ' (' + dbgErrorDetail + ')' : '') + '</span>';
    } else {
      statusHtml = '<span class="dim">loading&hellip;</span>';
    }

    bar.innerHTML =
      '<span class="lbl">DEBUG</span>' +
      ' &nbsp;<span class="dim">|</span>&nbsp; <kbd>D</kbd> toggle' +
      ' &nbsp;<span class="dim">|</span>&nbsp; <kbd>←</kbd><kbd>→</kbd> navigate' +
      ' &nbsp;<span class="dim">|</span>&nbsp; ' +
        (slideIndex + 1) + ' / ' + previews.length +
      ' &nbsp;<span class="dim">|</span>&nbsp; ' +
        'transition: <span style="color:#ffd54f">' + (dbgTransition || '—') + '</span>' +
      ' &nbsp;<span class="dim">|</span>&nbsp; ' + statusHtml +
      '<br><span class="url">' + url + '</span>';
  }

  // ── Keyboard + button navigation ───────────────────────────────────────────
  document.addEventListener("keydown", function(e) {
    if (e.key === "d" || e.key === "D") {
      setDebugMode(!debugMode);
      return;
    }
    if (!debugMode) return;
    if (e.key === "ArrowLeft") {
      slideIndex = (slideIndex - 1 + Math.max(previews.length, 1)) % Math.max(previews.length, 1);
      showSlide(slideIndex);
    } else if (e.key === "ArrowRight") {
      slideIndex = (slideIndex + 1) % Math.max(previews.length, 1);
      showSlide(slideIndex);
    }
  });

  document.getElementById("dbg-prev").addEventListener("click", function() {
    slideIndex = (slideIndex - 1 + Math.max(previews.length, 1)) % Math.max(previews.length, 1);
    showSlide(slideIndex);
  });

  document.getElementById("dbg-next").addEventListener("click", function() {
    slideIndex = (slideIndex + 1) % Math.max(previews.length, 1);
    showSlide(slideIndex);
  });

  // ── Phase 1: collage ───────────────────────────────────────────────────────
  async function fetchPreviews() {
    try {
      const resp = await fetch("/api/previews");
      if (!resp.ok) return;
      const fresh = await resp.json();

      if (fresh.length === 0) {
        document.getElementById("empty").style.display = "flex";
        return;
      }
      document.getElementById("empty").style.display = "none";

      const oldCount = previews.length;
      previews = fresh;

      if (!inSlideshow) {
        renderCollage();
        if (previews.length > 0) {
          setTimeout(enterSlideshow, 3000);
        }
      } else if (previews.length > oldCount) {
        // New images arrived while slideshowing — queue is already updated
      }
    } catch (err) {
      console.warn("fetchPreviews error:", err);
    }
  }

  function renderCollage() {
    const collage = document.getElementById("collage");
    collage.innerHTML = "";
    previews.forEach(function(p) {
      const wrap = document.createElement("div");
      wrap.className = "thumb";
      const img = document.createElement("img");
      img.src = p.preview_url;
      img.alt = p.filename;
      img.loading = "lazy";
      wrap.appendChild(img);
      collage.appendChild(wrap);
    });
  }

  // ── Phase 2: slideshow ─────────────────────────────────────────────────────
  function enterSlideshow() {
    if (inSlideshow) return;
    inSlideshow = true;

    const collage   = document.getElementById("collage");
    const slideshow = document.getElementById("slideshow");

    collage.style.opacity = "0";
    setTimeout(function() {
      collage.style.display = "none";
      slideshow.style.opacity = "1";
      showSlide(slideIndex);
      if (!debugMode) {
        slideTimer = setInterval(advance, SLIDE_INTERVAL_MS);
      }
    }, 1200);
  }

  function advance() {
    slideIndex = (slideIndex + 1) % Math.max(previews.length, 1);
    showSlide(slideIndex);
  }

  function showSlide(index) {
    const preview    = previews[index];
    if (!preview) return;

    const slideshow  = document.getElementById("slideshow");
    const transition = pickTransition();

    dbgTransition  = transition;
    dbgLoadStatus  = "loading";
    dbgErrorDetail = "";
    updateDebugBar();

    const img = new Image();
    img.src = imageUrl(preview.filename);

    img.onload = function() {
      dbgLoadStatus = "ok";
      updateDebugBar();

      const slide = document.createElement("div");
      slide.className = "slide transition-" + transition;
      const imgEl = document.createElement("img");
      imgEl.src = imageUrl(preview.filename);
      imgEl.alt = preview.filename;
      slide.appendChild(imgEl);
      slideshow.appendChild(slide);

      const slides = slideshow.querySelectorAll(".slide");
      if (slides.length > 2) {
        slides[0].remove();
      }
    };

    img.onerror = function() {
      dbgLoadStatus  = "error";
      dbgErrorDetail = "browser could not load image";
      updateDebugBar();
      console.error("Failed to load image:", imageUrl(preview.filename));
    };
  }

  // ── Boot ───────────────────────────────────────────────────────────────────
  fetchPreviews();
  setInterval(fetchPreviews, GRID_REFRESH_MS);
</script>

</body>
</html>
